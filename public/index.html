<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=no;">
    <title>나이스</title>
    <style>
        @font-face {
            font-family: gulimwoff;
            src: url(GulimChe.woff2);
        }

        @media (prefers-color-scheme: light) {
            body {
                background: white;
                color: black;
            }

            button {
                background-color: #4CAF50;
                color: black;
            }
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: black;
                color: white;
            }

            button {
                background-color: rgb(236, 193, 0);
                color: white;
            }

            .nameinput {
                background-color: #252525;
                color: white;
            }
        }

        body {
            font-family: 'gulimwoff';
            text-align: center;
            overflow-x: hidden;
        }

        button:disabled {
            background-color: #ccc;
        }

        img {
            width: 25%;
            height: 25%;
        }

        .btnd {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 20vh;
        }

        button {
            font-family: 'gulimwoff';
            width: 30vw;
            aspect-ratio: 1;
            font-size: 6.5vw;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            transition: background-color 0.3s;
            margin-top: 1vw;
        }

        .nameinput {
            font-family: 'gulimwoff';
            display: inline-block;
            margin-left: 10px;
            width: 50%;
            height: 7vw;
            font-size: 5vw;
            padding: 5px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 50px;
            text-align: center;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="font-size: 7vw;">몬티홀 문제 체험하기!</h1>
        <input type="text" id='name' placeholder="학번이랑 이름 적기" class="nameinput">
        <div class="imgd">
            <img onclick='imgtri(0)' id='p0'>
            <img onclick='imgtri(1)' id='p1'>
            <img onclick='imgtri(2)' id='p2'>
        </div>
        <div style="width: 100%; height: 2vw; margin-bottom: 3vw;">
            <h1 id="prompt">문을 하나 선택해주세요</h1>
        </div>
        <div class="btnd">
            <button onclick='trigged(0)' id='b0'>문 1</button>
            <button onclick='trigged(1)' id='b1'>문 2</button>
            <button onclick='trigged(2)' id='b2'>문 3</button>
        </div>
        <div id="gameResult"></div>
        <div id="result">
            <p id="finalResult"></p>
        </div>
        <div id="savedResults">
            <h2 style="font-size: 5vw;">리더보드</h2>
            <h1 id="totalStats" style="margin-top: 1vw; margin-bottom: 1vw; font-size: 2vw;"></h1>
            <table id="data-table" style="font-size: 2.75vw;">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>총 플레이 수</th>
                        <th>바꿨을때 승률</th>
                        <th>안바꿨을때 승률</th>
                        <th>날짜</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 데이터가 여기에 삽입됩니다. -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        document.documentElement.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, false); lastTouchEnd = 0;
        document.documentElement.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        const initTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        let n = 0, b_;
        reset()
        function reset() {
            n = 0
            c = Math.floor(Math.random() * 3);
            document.getElementById('b0').disabled = false;
            document.getElementById('b1').disabled = false;
            document.getElementById('b2').disabled = false;
            document.getElementById('p0').src = initTheme + ".closed.webp";
            document.getElementById('p1').src = initTheme + ".closed.webp";
            document.getElementById('p2').src = initTheme + ".closed.webp";
        }
        async function fetchData() {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';

            try {
                const response = await fetch('/data');
                const data = await response.json();

                // 누적 값 초기화
                let t_nwin = 0;
                let t_cwin = 0;
                let t_nplay = 0;
                let t_cplay = 0;
                let t_count = 0; // Initialize total play count

                // 각 항목을 테이블에 추가하고, 누적 값 계산
                data.forEach(item => {
                    const row = document.createElement('tr');
                    const formattedTime = formatDate(item.ptime); // 시간 포맷팅
                    row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.totalcount}</td>
                <td>${Math.round(item.cwin / item.cplay * 100) + '%'}</td>
                <td>${Math.round(item.nwin / item.nplay * 100) + '%'}</td>
                <td>${formattedTime}</td>
            `;
                    tableBody.appendChild(row);

                    // 누적합 계산
                    t_nwin += item.nwin;
                    t_cwin += item.cwin;
                    t_nplay += item.nplay;
                    t_cplay += item.cplay;
                    t_count += item.totalcount;
                });
                // 누적 값 출력
                document.getElementById('totalStats').innerHTML = `
            <p>총 플레이 수 : ${t_count}</p>
            <p>바꿨을 때 승리 평균 : ${Math.round(t_cwin / (t_cplay || 1) * 100) + '%'}</p>
            <p>안 바꿨을 때 승리 평균 : ${Math.round(t_nwin / (t_nplay || 1) * 100) + '%'}</p>
        `;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function formatDate(ptime) {
            const date = new Date(ptime);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function imgtri(x) {
            document.getElementById('p' + x).src = initTheme + ".open.webp";
            n++;
            document.getElementById('prompt').innerHTML = '다른 문으로 바꿔주세요';
            document.getElementById('b0').disabled = true;
            document.getElementById('b1').disabled = true;
            document.getElementById('b2').disabled = true;
        }

        function trigged(x) {
            let t = false;
            if (x == c) {
                t = true;
            }
            document.getElementById('b' + x).style.backgroundColor = "green";
            if (t) {
                document.getElementById('finalResult').innerHTML = "이겼습니다! 냉큼 사탕받으러 오세요";
                win(t);
            } else {
                document.getElementById('finalResult').innerHTML = "아쉽노ㅋ 한번 더 ㄱ?";
                win(t);
            }
            // Disable buttons
            document.getElementById('b0').disabled = true;
            document.getElementById('b1').disabled = true;
            document.getElementById('b2').disabled = true;
            reset();
            setTimeout(() => {
                reset();
            }, 5000);
        }

        async function win(t) {
            let name = document.getElementById('name').value;
            if (name) {
                let response = await fetch('/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        win: t
                    })
                });
                await fetchData();
            }
        }
    </script>
</body>
</html>