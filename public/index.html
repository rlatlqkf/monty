<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=no;" />
    <title>나이스</title>
    <style>
        @font-face {
            font-family: gulimwoff;
            src: url(GulimChe.woff2);
        }

        @media (prefers-color-scheme: light) {
            body {
                background: white;
                color: black;
            }

            button {
                background-color: #4CAF50;
                color: black;
            }
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: black;
                color: white;
            }

            button {
                background-color: rgb(236, 193, 0);
                color: white;
            }

            .nameinput {
                background-color: #252525;
                color: white;
            }
        }

        body {
            font-family: 'gulimwoff';
            text-align: center;
            overflow-x: hidden;
        }

        button:disabled {
            background-color: #ccc;
        }

        img {
            width: 32%;
            height: 32%;
        }

        .btnd {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 20vh;
        }

        button {
            font-family: 'gulimwoff';
            width: 30vw;
            aspect-ratio: 1;
            font-size: 8vw;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            transition: background-color 0.3s;
        }

        .nameinput {
            font-family: 'gulimwoff';
            display: inline-block;
            margin-left: 10px;
            width: 50%;
            height: 7vw;
            font-size: 5vw;
            padding: 5px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 50px;
            text-align: center;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="font-size: 7vw;">몬티홀 문제 체험하기!</h1>
        <input type="text" id='name' placeholder="학번이랑 이름 적기" class="nameinput">
        <div class="imgd">
            <img onclick='imgtri(0)' id='p0'>
            <img onclick='imgtri(1)' id='p1'>
            <img onclick='imgtri(2)' id='p2'>
        </div>
        <div style="width: 100%; height: 2vw; margin-bottom: 2vw;">
            <h1 id="prompt">문을 하나 선택해주세요</h1>
        </div>
        <div class="btnd">
            <button onclick='trigged(0)' id='b0'>문 1</button>
            <button onclick='trigged(1)' id='b1'>문 2</button>
            <button onclick='trigged(2)' id='b2'>문 3</button>
        </div>
        <div id="gameResult"></div>
        <div id="result">
            <p id="finalResult"></p>
        </div>
        <div id="savedResults" class="hidden">
            <h2 style="font-size: 5vw;">리더보드</h2>
            <h2 style="font-size: 3vw; margin-bottom: 1vw; margin-top: 1vw;" id="totalCountDisplay"></h2>
            <table id="data-table" style="font-size: 2.75vw;">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>총 플레이 수</th>
                        <th>바꿨을때 승률</th>
                        <th>안바꿨을때 승률</th>
                        <th>날짜</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 데이터가 여기에 삽입됩니다. -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        document.documentElement.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, false); lastTouchEnd = 0;
        document.documentElement.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        const initTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        let n = 0, b_;
        reset()
        function reset() {
            n = 0
            c = Math.floor(Math.random() * 3);
            document.getElementById('b0').disabled = false;
            document.getElementById('b1').disabled = false;
            document.getElementById('b2').disabled = false;
            document.getElementById('p0').src = initTheme + ".closed.webp";
            document.getElementById('p1').src = initTheme + ".closed.webp";
            document.getElementById('p2').src = initTheme + ".closed.webp";
        }
        async function fetchData() {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/data', true);
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const data = JSON.parse(xhr.responseText);
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.totalcount}</td>
                    <td>${Math.round(item.cwin / item.totalcount * 100) + '%'}</td>
                    <td>${Math.round(item.nwin / item.toIalcount * 100) + '%'}</td>
                    <td>${item.ptime}</td>
                `;
                        tableBody.appendChild(row);
                    });
                } else {
                    console.error('데이터를 가져오는 중 오류 발생:', xhr.statusText);
                }
            };
            xhr.onerror = function () {
                console.error('요청 중 오류 발생');
            };
            xhr.send();
        }

        function imgtri(m) { if (document.getElementById('b' + m).disabled == false) { trigged(m) } }
        function trigged(b) {
            n++
            if (document.getElementById('name').value.replace(/\s+/g, '') === "" || document.getElementById('name').value.replace(/\s+/g, '') === "TOTAL") {
                alert("학번과 이름을 입력해주세요");
                document.getElementById('name').focus();
            } else {
                localStorage.setItem('savedname', document.getElementById('name').value.replace(/\s+/g, ''));
                if (n == 1) {
                    document.getElementById("prompt").innerHTML = (b + 1) + "번 문을 선택하셨습니다. 염소 있는곳 보여드림";
                    goatg = [0, 1, 2].filter(item => item !== c)
                    if (goatg.includes(b) == true) {
                        document.getElementById('p' + goatg.filter(item => item !== b)).src = initTheme + ".goat.webp";
                        document.getElementById('b' + goatg.filter(item => item !== b)).disabled = true;
                    } else if (goatg.includes(b) == false) {
                        vv = Math.floor(Math.random() * 2);
                        document.getElementById('p' + (goatg[vv])).src = initTheme + ".goat.webp";
                        document.getElementById('b' + (goatg[vv])).disabled = true;
                    }
                    b_ = b
                } else if (n == 2) {
                    fetchData()
                    switch (true) {
                        case (b == c && b != b_): // 바꾸고 이김
                            document.getElementById('p' + b).src = initTheme + ".car.webp";
                            document.getElementById("prompt").innerHTML = "축하합니다! 냉큼 사탕받으로 1-6으로 ㄱㄱ"
                            playAudio('cor.mp3');
                            updateOrAddScore(0);
                            break;
                        case (b == c && b == b_): // 안 바꾸고 이김
                            document.getElementById('p' + b).src = initTheme + ".car.webp";
                            document.getElementById("prompt").innerHTML = "축하합니다! 냉큼 사탕받으로 1-6으로 ㄱㄱ"
                            playAudio('cor.mp3');
                            updateOrAddScore(1);
                            break;
                        case (b != c): // 안 바꾸고 짐
                            updateOrAddScore();
                            document.getElementById('p' + b).src = initTheme + ".goat.webp";
                            document.getElementById("prompt").innerHTML = "아숩노ㅋ 한번더 ㄱ?"
                            playAudio('inc.mp3')
                            break;

                    }
                    fetchDataAndCalculateTotalCount()
                } else if (n <= 3) {
                    reset()
                }
            }
        }
        fetchData();

        if (localStorage.getItem('savedname') !== null) {
            document.getElementById('name').value = localStorage.getItem('savedname');
        }

        function playAudio(file) {
            new Audio(file).play();
        }

        async function updateOrAddScore(resultType) {
            const username = document.getElementById('name').value.replace(/\s+/g, '');
            try {
                const response = await fetch('/data');
                const leaderboardData = await response.json();
                let entry = leaderboardData.find(item => item.name === username);

                if (!entry) {
                    entry = {
                        name: username,
                        totalcount: 1,
                        cwin: 0,
                        nwin: 0,
                        ptime: new Date().toISOString().slice(5, 19).replace('T', ' ')
                    };
                    leaderboardData.push(entry);
                } else {
                    entry.totalcount++;
                    entry.ptime = new Date().toISOString().slice(5, 19).replace('T', ' ');
                }

                if (resultType === 0) {  // 바꾸고 이김
                    entry.cwin++;
                } else if (resultType === 1) {  // 안바꾸고 이김
                    entry.nwin++;
                }

                await fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(entry) // 여기서 entry를 보내야 함
            });
            } catch (error) {
                console.error('데이터 업데이트 오류:', error);
            }
        }
        async function fetchDataAndCalculateTotalCount() {
            const response = await fetch('/data');
            const data = await response.json();
            const t_totalcount = data.reduce((sum, item) => sum + (item.totalcount || 0), 0);
            const t_cwin = data.reduce((sum, item) => sum + (item.cwin || 0), 0);
            const t_nwin = data.reduce((sum, item) => sum + (item.nwin || 0), 0);
            document.getElementById('totalCountDisplay').innerText = `총 플레이 수: ${totalCount}&nbsp;평균적인 안 바꿨을때 승률: ${Math.round(t_cwin / t_totalcount * 100) + '%'}&nbsp;평균적인 바꿨을때 승률: ${Math.round(t_nwin / t_totalcount * 100) + '%'}`;
        }

        // 페이지 로드 시 데이터 가져오기 및 총합 계산
        window.onload = fetchDataAndCalculateTotalCount;
    </script>
</body>

</html>